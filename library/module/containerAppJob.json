{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.40.2.10011",
      "templateHash": "11408561663524699226"
    }
  },
  "parameters": {
    "jobName": {
      "type": "string",
      "metadata": {
        "description": "Job name"
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "australiaeast",
      "metadata": {
        "description": "Azure region for resources"
      }
    },
    "tags": {
      "type": "object",
      "defaultValue": {},
      "metadata": {
        "description": "Tags to apply to the container app job"
      }
    },
    "containerAppsEnvironmentId": {
      "type": "string",
      "metadata": {
        "description": "Container Apps Environment resource ID"
      }
    },
    "managedIdentityId": {
      "type": "string",
      "metadata": {
        "description": "Managed identity resource ID"
      }
    },
    "containerImage": {
      "type": "string",
      "defaultValue": "mcr.microsoft.com/azuredocs/containerapps-helloworld:latest",
      "metadata": {
        "description": "Container image (e.g., mcr.microsoft.com/azuredocs/containerapps-helloworld:latest)"
      }
    },
    "containerName": {
      "type": "string",
      "defaultValue": "main-container",
      "metadata": {
        "description": "Container name"
      }
    },
    "cpu": {
      "type": "string",
      "defaultValue": "0.25",
      "metadata": {
        "description": "CPU cores for the container"
      }
    },
    "memory": {
      "type": "string",
      "defaultValue": "0.5Gi",
      "metadata": {
        "description": "Memory for the container"
      }
    },
    "triggerType": {
      "type": "string",
      "defaultValue": "Manual",
      "allowedValues": [
        "Manual",
        "Schedule",
        "Event"
      ],
      "metadata": {
        "description": "Trigger type for the job"
      }
    },
    "cronExpression": {
      "type": "string",
      "defaultValue": "0 0 * * *",
      "metadata": {
        "description": "Cron expression for scheduled jobs (only used when triggerType is Schedule)"
      }
    },
    "replicaTimeout": {
      "type": "int",
      "defaultValue": 1800,
      "metadata": {
        "description": "Replica timeout in seconds"
      }
    },
    "replicaRetryLimit": {
      "type": "int",
      "defaultValue": 0,
      "metadata": {
        "description": "Replica retry limit"
      }
    },
    "parallelism": {
      "type": "int",
      "defaultValue": 1,
      "metadata": {
        "description": "Parallelism (number of replicas to start per job execution)"
      }
    },
    "replicaCompletionCount": {
      "type": "int",
      "defaultValue": 1,
      "metadata": {
        "description": "Replica completions"
      }
    }
  },
  "resources": [
    {
      "type": "Microsoft.App/jobs",
      "apiVersion": "2023-05-01",
      "name": "[parameters('jobName')]",
      "location": "[parameters('location')]",
      "tags": "[parameters('tags')]",
      "identity": {
        "type": "UserAssigned",
        "userAssignedIdentities": {
          "[format('{0}', parameters('managedIdentityId'))]": {}
        }
      },
      "properties": {
        "environmentId": "[parameters('containerAppsEnvironmentId')]",
        "configuration": {
          "replicaTimeout": "[parameters('replicaTimeout')]",
          "replicaRetryLimit": "[parameters('replicaRetryLimit')]",
          "triggerType": "[parameters('triggerType')]",
          "manualTriggerConfig": "[if(equals(parameters('triggerType'), 'Manual'), createObject('parallelism', parameters('parallelism'), 'replicaCompletionCount', parameters('replicaCompletionCount')), null())]",
          "scheduleTriggerConfig": "[if(equals(parameters('triggerType'), 'Schedule'), createObject('cronExpression', parameters('cronExpression'), 'parallelism', parameters('parallelism'), 'replicaCompletionCount', parameters('replicaCompletionCount')), null())]"
        },
        "template": {
          "containers": [
            {
              "name": "[parameters('containerName')]",
              "image": "[parameters('containerImage')]",
              "resources": {
                "cpu": "[json(parameters('cpu'))]",
                "memory": "[parameters('memory')]"
              }
            }
          ]
        }
      }
    }
  ],
  "outputs": {
    "containerAppJobName": {
      "type": "string",
      "metadata": {
        "description": "The name of the container app job"
      },
      "value": "[parameters('jobName')]"
    },
    "containerAppJobId": {
      "type": "string",
      "metadata": {
        "description": "The resource ID of the container app job"
      },
      "value": "[resourceId('Microsoft.App/jobs', parameters('jobName'))]"
    }
  }
}