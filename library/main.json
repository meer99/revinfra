{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.40.2.10011",
      "templateHash": "15555201670130489220"
    }
  },
  "parameters": {
    "environment": {
      "type": "string",
      "allowedValues": [
        "dev",
        "uat",
        "prod"
      ],
      "metadata": {
        "description": "Environment name (dev, uat, prod)"
      }
    }
  },
  "variables": {
    "$fxv#0": {
      "location": "australiaeast",
      "subscriptionName": "rebcsubtest",
      "vnetName": "vnet-rebc",
      "subnetName": "snet-rebc",
      "namePatterns": {
        "resourceGroup": "rg-rebc",
        "managedIdentity": "mi-rebc",
        "containerRegistry": "acraetestrebc",
        "containerAppsEnvironment": "cae-rebc",
        "containerAppJobBill": "caj-bill",
        "containerAppJobData": "caj-data",
        "sqlServer": "sql-rebc",
        "sqlDatabase": "db-rebc",
        "logAnalyticsWorkspace": "log-rebc",
        "privateEndpointContainerRegistry": "pe-cr",
        "privateEndpointContainerAppsEnvironment": "pe-cae",
        "privateEndpointSqlServer": "pe-sql"
      }
    },
    "$fxv#1": {
      "Project": "REBC",
      "ManagedBy": "Infrastructure Team",
      "CostCenter": "IT-001",
      "Department": "Infrastructure"
    },
    "$fxv#2": {
      "dev": {
        "deployResourceGroup": true,
        "deployManagedIdentity": true,
        "deployLogAnalyticsWorkspace": true,
        "deployContainerRegistry": true,
        "deployContainerAppsEnvironment": true,
        "deployContainerAppJobBill": true,
        "deployContainerAppJobData": true,
        "deploySqlServer": true,
        "deploySqlDatabase": true,
        "deployPrivateEndpointContainerRegistry": true,
        "deployPrivateEndpointContainerAppsEnvironment": true,
        "deployPrivateEndpointSqlServer": true,
        "sqlAdministratorLogin": "sqladmin",
        "sqlAdministratorLoginPassword": "P@ssw0rd123!Dev",
        "existingVnetResourceGroup": "rg-network-dev",
        "containerImage": "mcr.microsoft.com/azuredocs/containerapps-helloworld:latest"
      },
      "uat": {
        "deployResourceGroup": true,
        "deployManagedIdentity": true,
        "deployLogAnalyticsWorkspace": true,
        "deployContainerRegistry": true,
        "deployContainerAppsEnvironment": true,
        "deployContainerAppJobBill": true,
        "deployContainerAppJobData": true,
        "deploySqlServer": true,
        "deploySqlDatabase": true,
        "deployPrivateEndpointContainerRegistry": true,
        "deployPrivateEndpointContainerAppsEnvironment": true,
        "deployPrivateEndpointSqlServer": true,
        "sqlAdministratorLogin": "sqladmin",
        "sqlAdministratorLoginPassword": "P@ssw0rd123!Uat",
        "existingVnetResourceGroup": "rg-network-uat",
        "containerImage": "mcr.microsoft.com/azuredocs/containerapps-helloworld:latest"
      },
      "prod": {
        "deployResourceGroup": true,
        "deployManagedIdentity": true,
        "deployLogAnalyticsWorkspace": true,
        "deployContainerRegistry": true,
        "deployContainerAppsEnvironment": true,
        "deployContainerAppJobBill": true,
        "deployContainerAppJobData": true,
        "deploySqlServer": true,
        "deploySqlDatabase": true,
        "deployPrivateEndpointContainerRegistry": true,
        "deployPrivateEndpointContainerAppsEnvironment": true,
        "deployPrivateEndpointSqlServer": true,
        "sqlAdministratorLogin": "sqladmin",
        "sqlAdministratorLoginPassword": "P@ssw0rd123!Prod",
        "existingVnetResourceGroup": "rg-network-prod",
        "containerImage": "mcr.microsoft.com/azuredocs/containerapps-helloworld:latest"
      }
    },
    "variables": "[variables('$fxv#0')]",
    "commonTags": "[variables('$fxv#1')]",
    "parametersAll": "[variables('$fxv#2')]",
    "envParams": "[variables('parametersAll')[parameters('environment')]]",
    "tags": "[union(variables('commonTags'), createObject('Environment', parameters('environment')))]",
    "location": "[variables('variables').location]",
    "namePatterns": "[variables('variables').namePatterns]",
    "vnetName": "[variables('variables').vnetName]",
    "subnetName": "[variables('variables').subnetName]",
    "existingVnetResourceGroup": "[variables('envParams').existingVnetResourceGroup]",
    "resourceGroupName": "[format('{0}-{1}', variables('namePatterns').resourceGroup, parameters('environment'))]"
  },
  "resources": [
    {
      "condition": "[variables('envParams').deployResourceGroup]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('deploy-rg-{0}', parameters('environment'))]",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "environment": {
            "value": "[parameters('environment')]"
          },
          "location": {
            "value": "[variables('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "namePattern": {
            "value": "[variables('namePatterns').resourceGroup]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.40.2.10011",
              "templateHash": "6891634486678387132"
            }
          },
          "parameters": {
            "environment": {
              "type": "string",
              "metadata": {
                "description": "Environment name (dev, uat, prod)"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "australiaeast",
              "metadata": {
                "description": "Azure region for resources"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags to apply to the resource group"
              }
            },
            "namePattern": {
              "type": "string",
              "defaultValue": "rg-rebc",
              "metadata": {
                "description": "Resource group name pattern"
              }
            }
          },
          "variables": {
            "resourceGroupName": "[format('{0}-{1}', parameters('namePattern'), parameters('environment'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Resources/resourceGroups",
              "apiVersion": "2023-07-01",
              "name": "[variables('resourceGroupName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]"
            }
          ],
          "outputs": {
            "resourceGroupName": {
              "type": "string",
              "metadata": {
                "description": "The name of the resource group"
              },
              "value": "[variables('resourceGroupName')]"
            },
            "resourceGroupId": {
              "type": "string",
              "metadata": {
                "description": "The ID of the resource group"
              },
              "value": "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('resourceGroupName'))]"
            },
            "resourceGroupLocation": {
              "type": "string",
              "metadata": {
                "description": "The location of the resource group"
              },
              "value": "[reference(subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('resourceGroupName')), '2023-07-01', 'full').location]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('deploy-resources-{0}', parameters('environment'))]",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "environment": {
            "value": "[parameters('environment')]"
          },
          "location": {
            "value": "[variables('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "namePatterns": {
            "value": "[variables('namePatterns')]"
          },
          "vnetName": {
            "value": "[variables('vnetName')]"
          },
          "subnetName": {
            "value": "[variables('subnetName')]"
          },
          "existingVnetResourceGroup": {
            "value": "[variables('existingVnetResourceGroup')]"
          },
          "envParams": {
            "value": "[variables('envParams')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.40.2.10011",
              "templateHash": "12605217183412803112"
            }
          },
          "parameters": {
            "environment": {
              "type": "string",
              "metadata": {
                "description": "Environment name (dev, uat, prod)"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for resources"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Tags to apply to resources"
              }
            },
            "namePatterns": {
              "type": "object",
              "metadata": {
                "description": "Name patterns for resources"
              }
            },
            "vnetName": {
              "type": "string",
              "metadata": {
                "description": "VNet name"
              }
            },
            "subnetName": {
              "type": "string",
              "metadata": {
                "description": "Subnet name"
              }
            },
            "existingVnetResourceGroup": {
              "type": "string",
              "metadata": {
                "description": "Existing VNet resource group"
              }
            },
            "envParams": {
              "type": "object",
              "metadata": {
                "description": "Environment parameters"
              }
            }
          },
          "resources": [
            {
              "condition": "[parameters('envParams').deployManagedIdentity]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('deploy-mi-{0}', parameters('environment'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "environment": {
                    "value": "[parameters('environment')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "namePattern": {
                    "value": "[parameters('namePatterns').managedIdentity]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.40.2.10011",
                      "templateHash": "16615554712851647292"
                    }
                  },
                  "parameters": {
                    "environment": {
                      "type": "string",
                      "metadata": {
                        "description": "Environment name (dev, uat, prod)"
                      }
                    },
                    "location": {
                      "type": "string",
                      "defaultValue": "australiaeast",
                      "metadata": {
                        "description": "Azure region for resources"
                      }
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {},
                      "metadata": {
                        "description": "Tags to apply to the managed identity"
                      }
                    },
                    "namePattern": {
                      "type": "string",
                      "defaultValue": "mi-rebc",
                      "metadata": {
                        "description": "Managed identity name pattern"
                      }
                    }
                  },
                  "variables": {
                    "managedIdentityName": "[format('{0}-{1}', parameters('namePattern'), parameters('environment'))]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
                      "apiVersion": "2023-01-31",
                      "name": "[variables('managedIdentityName')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]"
                    }
                  ],
                  "outputs": {
                    "managedIdentityName": {
                      "type": "string",
                      "metadata": {
                        "description": "The name of the managed identity"
                      },
                      "value": "[variables('managedIdentityName')]"
                    },
                    "managedIdentityId": {
                      "type": "string",
                      "metadata": {
                        "description": "The resource ID of the managed identity"
                      },
                      "value": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('managedIdentityName'))]"
                    },
                    "managedIdentityPrincipalId": {
                      "type": "string",
                      "metadata": {
                        "description": "The principal ID of the managed identity"
                      },
                      "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('managedIdentityName')), '2023-01-31').principalId]"
                    },
                    "managedIdentityClientId": {
                      "type": "string",
                      "metadata": {
                        "description": "The client ID of the managed identity"
                      },
                      "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('managedIdentityName')), '2023-01-31').clientId]"
                    }
                  }
                }
              }
            },
            {
              "condition": "[parameters('envParams').deployLogAnalyticsWorkspace]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('deploy-log-{0}', parameters('environment'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "environment": {
                    "value": "[parameters('environment')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "namePattern": {
                    "value": "[parameters('namePatterns').logAnalyticsWorkspace]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.40.2.10011",
                      "templateHash": "18425309681920878100"
                    }
                  },
                  "parameters": {
                    "environment": {
                      "type": "string",
                      "metadata": {
                        "description": "Environment name (dev, uat, prod)"
                      }
                    },
                    "location": {
                      "type": "string",
                      "defaultValue": "australiaeast",
                      "metadata": {
                        "description": "Azure region for resources"
                      }
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {},
                      "metadata": {
                        "description": "Tags to apply to the workspace"
                      }
                    },
                    "namePattern": {
                      "type": "string",
                      "defaultValue": "log-rebc",
                      "metadata": {
                        "description": "Log Analytics workspace name pattern"
                      }
                    },
                    "sku": {
                      "type": "string",
                      "defaultValue": "PerGB2018",
                      "allowedValues": [
                        "PerGB2018",
                        "Free",
                        "Standalone",
                        "PerNode"
                      ],
                      "metadata": {
                        "description": "Workspace SKU"
                      }
                    },
                    "retentionInDays": {
                      "type": "int",
                      "defaultValue": 30,
                      "minValue": 30,
                      "maxValue": 730,
                      "metadata": {
                        "description": "Data retention in days"
                      }
                    }
                  },
                  "variables": {
                    "workspaceName": "[format('{0}-{1}', parameters('namePattern'), parameters('environment'))]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.OperationalInsights/workspaces",
                      "apiVersion": "2022-10-01",
                      "name": "[variables('workspaceName')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "properties": {
                        "sku": {
                          "name": "[parameters('sku')]"
                        },
                        "retentionInDays": "[parameters('retentionInDays')]",
                        "features": {
                          "enableLogAccessUsingOnlyResourcePermissions": true
                        },
                        "publicNetworkAccessForIngestion": "Enabled",
                        "publicNetworkAccessForQuery": "Enabled"
                      }
                    }
                  ],
                  "outputs": {
                    "workspaceName": {
                      "type": "string",
                      "metadata": {
                        "description": "The name of the Log Analytics workspace"
                      },
                      "value": "[variables('workspaceName')]"
                    },
                    "workspaceId": {
                      "type": "string",
                      "metadata": {
                        "description": "The resource ID of the Log Analytics workspace"
                      },
                      "value": "[resourceId('Microsoft.OperationalInsights/workspaces', variables('workspaceName'))]"
                    },
                    "workspaceCustomerId": {
                      "type": "string",
                      "metadata": {
                        "description": "The customer ID of the Log Analytics workspace"
                      },
                      "value": "[reference(resourceId('Microsoft.OperationalInsights/workspaces', variables('workspaceName')), '2022-10-01').customerId]"
                    }
                  }
                }
              }
            },
            {
              "condition": "[parameters('envParams').deployContainerRegistry]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('deploy-acr-{0}', parameters('environment'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "environment": {
                    "value": "[parameters('environment')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "namePattern": {
                    "value": "[parameters('namePatterns').containerRegistry]"
                  },
                  "managedIdentityId": {
                    "value": "[reference(resourceId('Microsoft.Resources/deployments', format('deploy-mi-{0}', parameters('environment'))), '2025-04-01').outputs.managedIdentityId.value]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.40.2.10011",
                      "templateHash": "1884607179678455081"
                    }
                  },
                  "parameters": {
                    "environment": {
                      "type": "string",
                      "metadata": {
                        "description": "Environment name (dev, uat, prod)"
                      }
                    },
                    "location": {
                      "type": "string",
                      "defaultValue": "australiaeast",
                      "metadata": {
                        "description": "Azure region for resources"
                      }
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {},
                      "metadata": {
                        "description": "Tags to apply to the container registry"
                      }
                    },
                    "namePattern": {
                      "type": "string",
                      "defaultValue": "acraetestrebc",
                      "metadata": {
                        "description": "Container registry name pattern"
                      }
                    },
                    "managedIdentityId": {
                      "type": "string",
                      "metadata": {
                        "description": "Managed identity resource ID"
                      }
                    },
                    "sku": {
                      "type": "string",
                      "defaultValue": "Premium",
                      "allowedValues": [
                        "Basic",
                        "Standard",
                        "Premium"
                      ],
                      "metadata": {
                        "description": "SKU for the container registry"
                      }
                    },
                    "adminUserEnabled": {
                      "type": "bool",
                      "defaultValue": false,
                      "metadata": {
                        "description": "Enable admin user"
                      }
                    }
                  },
                  "variables": {
                    "containerRegistryName": "[format('{0}{1}', parameters('namePattern'), parameters('environment'))]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.ContainerRegistry/registries",
                      "apiVersion": "2023-07-01",
                      "name": "[variables('containerRegistryName')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "sku": {
                        "name": "[parameters('sku')]"
                      },
                      "identity": {
                        "type": "UserAssigned",
                        "userAssignedIdentities": {
                          "[format('{0}', parameters('managedIdentityId'))]": {}
                        }
                      },
                      "properties": {
                        "adminUserEnabled": "[parameters('adminUserEnabled')]",
                        "publicNetworkAccess": "Disabled",
                        "networkRuleBypassOptions": "AzureServices",
                        "zoneRedundancy": "Disabled",
                        "dataEndpointEnabled": false,
                        "encryption": {
                          "status": "disabled"
                        }
                      }
                    }
                  ],
                  "outputs": {
                    "containerRegistryName": {
                      "type": "string",
                      "metadata": {
                        "description": "The name of the container registry"
                      },
                      "value": "[variables('containerRegistryName')]"
                    },
                    "containerRegistryId": {
                      "type": "string",
                      "metadata": {
                        "description": "The resource ID of the container registry"
                      },
                      "value": "[resourceId('Microsoft.ContainerRegistry/registries', variables('containerRegistryName'))]"
                    },
                    "containerRegistryLoginServer": {
                      "type": "string",
                      "metadata": {
                        "description": "The login server of the container registry"
                      },
                      "value": "[reference(resourceId('Microsoft.ContainerRegistry/registries', variables('containerRegistryName')), '2023-07-01').loginServer]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', format('deploy-mi-{0}', parameters('environment')))]"
              ]
            },
            {
              "condition": "[parameters('envParams').deployPrivateEndpointContainerRegistry]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('deploy-pe-cr-{0}', parameters('environment'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "privateEndpointName": {
                    "value": "[format('{0}-{1}', parameters('namePatterns').privateEndpointContainerRegistry, parameters('environment'))]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "subnetId": {
                    "value": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('existingVnetResourceGroup')), 'Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), parameters('subnetName'))]"
                  },
                  "privateLinkServiceId": {
                    "value": "[reference(resourceId('Microsoft.Resources/deployments', format('deploy-acr-{0}', parameters('environment'))), '2025-04-01').outputs.containerRegistryId.value]"
                  },
                  "groupIds": {
                    "value": [
                      "registry"
                    ]
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.40.2.10011",
                      "templateHash": "7841778166094210874"
                    }
                  },
                  "parameters": {
                    "privateEndpointName": {
                      "type": "string",
                      "metadata": {
                        "description": "Private endpoint name"
                      }
                    },
                    "location": {
                      "type": "string",
                      "defaultValue": "australiaeast",
                      "metadata": {
                        "description": "Azure region for resources"
                      }
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {},
                      "metadata": {
                        "description": "Tags to apply to the private endpoint"
                      }
                    },
                    "subnetId": {
                      "type": "string",
                      "metadata": {
                        "description": "Subnet resource ID where the private endpoint will be created"
                      }
                    },
                    "privateLinkServiceId": {
                      "type": "string",
                      "metadata": {
                        "description": "Resource ID of the service to create a private endpoint for"
                      }
                    },
                    "groupIds": {
                      "type": "array",
                      "metadata": {
                        "description": "Group IDs for the private endpoint (e.g., registry, sqlServer, managedEnvironments)"
                      }
                    },
                    "enablePrivateDnsIntegration": {
                      "type": "bool",
                      "defaultValue": false,
                      "metadata": {
                        "description": "Enable private DNS integration"
                      }
                    },
                    "privateDnsZoneIds": {
                      "type": "array",
                      "defaultValue": [],
                      "metadata": {
                        "description": "Private DNS Zone IDs for DNS integration"
                      }
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/privateEndpoints",
                      "apiVersion": "2023-05-01",
                      "name": "[parameters('privateEndpointName')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "properties": {
                        "subnet": {
                          "id": "[parameters('subnetId')]"
                        },
                        "privateLinkServiceConnections": [
                          {
                            "name": "[parameters('privateEndpointName')]",
                            "properties": {
                              "privateLinkServiceId": "[parameters('privateLinkServiceId')]",
                              "groupIds": "[parameters('groupIds')]"
                            }
                          }
                        ]
                      }
                    },
                    {
                      "condition": "[and(parameters('enablePrivateDnsIntegration'), greater(length(parameters('privateDnsZoneIds')), 0))]",
                      "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
                      "apiVersion": "2023-05-01",
                      "name": "[format('{0}/{1}', parameters('privateEndpointName'), 'default')]",
                      "properties": {
                        "copy": [
                          {
                            "name": "privateDnsZoneConfigs",
                            "count": "[length(parameters('privateDnsZoneIds'))]",
                            "input": {
                              "name": "[format('config{0}', copyIndex('privateDnsZoneConfigs'))]",
                              "properties": {
                                "privateDnsZoneId": "[parameters('privateDnsZoneIds')[copyIndex('privateDnsZoneConfigs')]]"
                              }
                            }
                          }
                        ]
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/privateEndpoints', parameters('privateEndpointName'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "privateEndpointName": {
                      "type": "string",
                      "metadata": {
                        "description": "The name of the private endpoint"
                      },
                      "value": "[parameters('privateEndpointName')]"
                    },
                    "privateEndpointId": {
                      "type": "string",
                      "metadata": {
                        "description": "The resource ID of the private endpoint"
                      },
                      "value": "[resourceId('Microsoft.Network/privateEndpoints', parameters('privateEndpointName'))]"
                    },
                    "privateEndpointIpAddress": {
                      "type": "string",
                      "metadata": {
                        "description": "The private IP address of the private endpoint"
                      },
                      "value": "[reference(resourceId('Microsoft.Network/privateEndpoints', parameters('privateEndpointName')), '2023-05-01').customDnsConfigs[0].ipAddresses[0]]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', format('deploy-acr-{0}', parameters('environment')))]"
              ]
            },
            {
              "condition": "[parameters('envParams').deployContainerAppsEnvironment]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('deploy-cae-{0}', parameters('environment'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "environment": {
                    "value": "[parameters('environment')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "namePattern": {
                    "value": "[parameters('namePatterns').containerAppsEnvironment]"
                  },
                  "logAnalyticsCustomerId": "[if(parameters('envParams').deployLogAnalyticsWorkspace, createObject('value', reference(resourceId('Microsoft.Resources/deployments', format('deploy-log-{0}', parameters('environment'))), '2025-04-01').outputs.workspaceCustomerId.value), createObject('value', ''))]",
                  "logAnalyticsSharedKey": "[if(parameters('envParams').deployLogAnalyticsWorkspace, createObject('value', listKeys(resourceId('Microsoft.OperationalInsights/workspaces', format('{0}-{1}', parameters('namePatterns').logAnalyticsWorkspace, parameters('environment'))), '2022-10-01').primarySharedKey), createObject('value', ''))]",
                  "subnetId": {
                    "value": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('existingVnetResourceGroup')), 'Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), parameters('subnetName'))]"
                  },
                  "internal": {
                    "value": true
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.40.2.10011",
                      "templateHash": "15399582418690744092"
                    }
                  },
                  "parameters": {
                    "environment": {
                      "type": "string",
                      "metadata": {
                        "description": "Environment name (dev, uat, prod)"
                      }
                    },
                    "location": {
                      "type": "string",
                      "defaultValue": "australiaeast",
                      "metadata": {
                        "description": "Azure region for resources"
                      }
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {},
                      "metadata": {
                        "description": "Tags to apply to the container apps environment"
                      }
                    },
                    "namePattern": {
                      "type": "string",
                      "defaultValue": "cae-rebc",
                      "metadata": {
                        "description": "Container Apps Environment name pattern"
                      }
                    },
                    "logAnalyticsCustomerId": {
                      "type": "string",
                      "metadata": {
                        "description": "Log Analytics workspace customer ID"
                      }
                    },
                    "logAnalyticsSharedKey": {
                      "type": "securestring",
                      "metadata": {
                        "description": "Log Analytics workspace shared key"
                      }
                    },
                    "subnetId": {
                      "type": "string",
                      "metadata": {
                        "description": "VNet configuration - Subnet resource ID"
                      }
                    },
                    "internal": {
                      "type": "bool",
                      "defaultValue": true,
                      "metadata": {
                        "description": "Enable internal load balancer mode for private access"
                      }
                    }
                  },
                  "variables": {
                    "containerAppsEnvironmentName": "[format('{0}-{1}', parameters('namePattern'), parameters('environment'))]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.App/managedEnvironments",
                      "apiVersion": "2023-05-01",
                      "name": "[variables('containerAppsEnvironmentName')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "properties": {
                        "appLogsConfiguration": {
                          "destination": "log-analytics",
                          "logAnalyticsConfiguration": {
                            "customerId": "[parameters('logAnalyticsCustomerId')]",
                            "sharedKey": "[parameters('logAnalyticsSharedKey')]"
                          }
                        },
                        "vnetConfiguration": {
                          "internal": "[parameters('internal')]",
                          "infrastructureSubnetId": "[parameters('subnetId')]"
                        },
                        "zoneRedundant": false
                      }
                    }
                  ],
                  "outputs": {
                    "containerAppsEnvironmentName": {
                      "type": "string",
                      "metadata": {
                        "description": "The name of the container apps environment"
                      },
                      "value": "[variables('containerAppsEnvironmentName')]"
                    },
                    "containerAppsEnvironmentId": {
                      "type": "string",
                      "metadata": {
                        "description": "The resource ID of the container apps environment"
                      },
                      "value": "[resourceId('Microsoft.App/managedEnvironments', variables('containerAppsEnvironmentName'))]"
                    },
                    "containerAppsEnvironmentDefaultDomain": {
                      "type": "string",
                      "metadata": {
                        "description": "The default domain of the container apps environment"
                      },
                      "value": "[reference(resourceId('Microsoft.App/managedEnvironments', variables('containerAppsEnvironmentName')), '2023-05-01').defaultDomain]"
                    },
                    "containerAppsEnvironmentStaticIp": {
                      "type": "string",
                      "metadata": {
                        "description": "The static IP address of the container apps environment"
                      },
                      "value": "[reference(resourceId('Microsoft.App/managedEnvironments', variables('containerAppsEnvironmentName')), '2023-05-01').staticIp]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', format('deploy-log-{0}', parameters('environment')))]"
              ]
            },
            {
              "condition": "[parameters('envParams').deployPrivateEndpointContainerAppsEnvironment]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('deploy-pe-cae-{0}', parameters('environment'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "privateEndpointName": {
                    "value": "[format('{0}-{1}', parameters('namePatterns').privateEndpointContainerAppsEnvironment, parameters('environment'))]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "subnetId": {
                    "value": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('existingVnetResourceGroup')), 'Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), parameters('subnetName'))]"
                  },
                  "privateLinkServiceId": {
                    "value": "[reference(resourceId('Microsoft.Resources/deployments', format('deploy-cae-{0}', parameters('environment'))), '2025-04-01').outputs.containerAppsEnvironmentId.value]"
                  },
                  "groupIds": {
                    "value": [
                      "managedEnvironments"
                    ]
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.40.2.10011",
                      "templateHash": "7841778166094210874"
                    }
                  },
                  "parameters": {
                    "privateEndpointName": {
                      "type": "string",
                      "metadata": {
                        "description": "Private endpoint name"
                      }
                    },
                    "location": {
                      "type": "string",
                      "defaultValue": "australiaeast",
                      "metadata": {
                        "description": "Azure region for resources"
                      }
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {},
                      "metadata": {
                        "description": "Tags to apply to the private endpoint"
                      }
                    },
                    "subnetId": {
                      "type": "string",
                      "metadata": {
                        "description": "Subnet resource ID where the private endpoint will be created"
                      }
                    },
                    "privateLinkServiceId": {
                      "type": "string",
                      "metadata": {
                        "description": "Resource ID of the service to create a private endpoint for"
                      }
                    },
                    "groupIds": {
                      "type": "array",
                      "metadata": {
                        "description": "Group IDs for the private endpoint (e.g., registry, sqlServer, managedEnvironments)"
                      }
                    },
                    "enablePrivateDnsIntegration": {
                      "type": "bool",
                      "defaultValue": false,
                      "metadata": {
                        "description": "Enable private DNS integration"
                      }
                    },
                    "privateDnsZoneIds": {
                      "type": "array",
                      "defaultValue": [],
                      "metadata": {
                        "description": "Private DNS Zone IDs for DNS integration"
                      }
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/privateEndpoints",
                      "apiVersion": "2023-05-01",
                      "name": "[parameters('privateEndpointName')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "properties": {
                        "subnet": {
                          "id": "[parameters('subnetId')]"
                        },
                        "privateLinkServiceConnections": [
                          {
                            "name": "[parameters('privateEndpointName')]",
                            "properties": {
                              "privateLinkServiceId": "[parameters('privateLinkServiceId')]",
                              "groupIds": "[parameters('groupIds')]"
                            }
                          }
                        ]
                      }
                    },
                    {
                      "condition": "[and(parameters('enablePrivateDnsIntegration'), greater(length(parameters('privateDnsZoneIds')), 0))]",
                      "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
                      "apiVersion": "2023-05-01",
                      "name": "[format('{0}/{1}', parameters('privateEndpointName'), 'default')]",
                      "properties": {
                        "copy": [
                          {
                            "name": "privateDnsZoneConfigs",
                            "count": "[length(parameters('privateDnsZoneIds'))]",
                            "input": {
                              "name": "[format('config{0}', copyIndex('privateDnsZoneConfigs'))]",
                              "properties": {
                                "privateDnsZoneId": "[parameters('privateDnsZoneIds')[copyIndex('privateDnsZoneConfigs')]]"
                              }
                            }
                          }
                        ]
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/privateEndpoints', parameters('privateEndpointName'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "privateEndpointName": {
                      "type": "string",
                      "metadata": {
                        "description": "The name of the private endpoint"
                      },
                      "value": "[parameters('privateEndpointName')]"
                    },
                    "privateEndpointId": {
                      "type": "string",
                      "metadata": {
                        "description": "The resource ID of the private endpoint"
                      },
                      "value": "[resourceId('Microsoft.Network/privateEndpoints', parameters('privateEndpointName'))]"
                    },
                    "privateEndpointIpAddress": {
                      "type": "string",
                      "metadata": {
                        "description": "The private IP address of the private endpoint"
                      },
                      "value": "[reference(resourceId('Microsoft.Network/privateEndpoints', parameters('privateEndpointName')), '2023-05-01').customDnsConfigs[0].ipAddresses[0]]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', format('deploy-cae-{0}', parameters('environment')))]"
              ]
            },
            {
              "condition": "[parameters('envParams').deployContainerAppJobBill]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('deploy-caj-bill-{0}', parameters('environment'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "jobName": {
                    "value": "[format('{0}-{1}', parameters('namePatterns').containerAppJobBill, parameters('environment'))]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "containerAppsEnvironmentId": {
                    "value": "[reference(resourceId('Microsoft.Resources/deployments', format('deploy-cae-{0}', parameters('environment'))), '2025-04-01').outputs.containerAppsEnvironmentId.value]"
                  },
                  "managedIdentityId": {
                    "value": "[reference(resourceId('Microsoft.Resources/deployments', format('deploy-mi-{0}', parameters('environment'))), '2025-04-01').outputs.managedIdentityId.value]"
                  },
                  "containerImage": {
                    "value": "[parameters('envParams').containerImage]"
                  },
                  "containerName": {
                    "value": "bill-processor"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.40.2.10011",
                      "templateHash": "11408561663524699226"
                    }
                  },
                  "parameters": {
                    "jobName": {
                      "type": "string",
                      "metadata": {
                        "description": "Job name"
                      }
                    },
                    "location": {
                      "type": "string",
                      "defaultValue": "australiaeast",
                      "metadata": {
                        "description": "Azure region for resources"
                      }
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {},
                      "metadata": {
                        "description": "Tags to apply to the container app job"
                      }
                    },
                    "containerAppsEnvironmentId": {
                      "type": "string",
                      "metadata": {
                        "description": "Container Apps Environment resource ID"
                      }
                    },
                    "managedIdentityId": {
                      "type": "string",
                      "metadata": {
                        "description": "Managed identity resource ID"
                      }
                    },
                    "containerImage": {
                      "type": "string",
                      "defaultValue": "mcr.microsoft.com/azuredocs/containerapps-helloworld:latest",
                      "metadata": {
                        "description": "Container image (e.g., mcr.microsoft.com/azuredocs/containerapps-helloworld:latest)"
                      }
                    },
                    "containerName": {
                      "type": "string",
                      "defaultValue": "main-container",
                      "metadata": {
                        "description": "Container name"
                      }
                    },
                    "cpu": {
                      "type": "string",
                      "defaultValue": "0.25",
                      "metadata": {
                        "description": "CPU cores for the container"
                      }
                    },
                    "memory": {
                      "type": "string",
                      "defaultValue": "0.5Gi",
                      "metadata": {
                        "description": "Memory for the container"
                      }
                    },
                    "triggerType": {
                      "type": "string",
                      "defaultValue": "Manual",
                      "allowedValues": [
                        "Manual",
                        "Schedule",
                        "Event"
                      ],
                      "metadata": {
                        "description": "Trigger type for the job"
                      }
                    },
                    "cronExpression": {
                      "type": "string",
                      "defaultValue": "0 0 * * *",
                      "metadata": {
                        "description": "Cron expression for scheduled jobs (only used when triggerType is Schedule)"
                      }
                    },
                    "replicaTimeout": {
                      "type": "int",
                      "defaultValue": 1800,
                      "metadata": {
                        "description": "Replica timeout in seconds"
                      }
                    },
                    "replicaRetryLimit": {
                      "type": "int",
                      "defaultValue": 0,
                      "metadata": {
                        "description": "Replica retry limit"
                      }
                    },
                    "parallelism": {
                      "type": "int",
                      "defaultValue": 1,
                      "metadata": {
                        "description": "Parallelism (number of replicas to start per job execution)"
                      }
                    },
                    "replicaCompletionCount": {
                      "type": "int",
                      "defaultValue": 1,
                      "metadata": {
                        "description": "Replica completions"
                      }
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.App/jobs",
                      "apiVersion": "2023-05-01",
                      "name": "[parameters('jobName')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "identity": {
                        "type": "UserAssigned",
                        "userAssignedIdentities": {
                          "[format('{0}', parameters('managedIdentityId'))]": {}
                        }
                      },
                      "properties": {
                        "environmentId": "[parameters('containerAppsEnvironmentId')]",
                        "configuration": {
                          "replicaTimeout": "[parameters('replicaTimeout')]",
                          "replicaRetryLimit": "[parameters('replicaRetryLimit')]",
                          "triggerType": "[parameters('triggerType')]",
                          "manualTriggerConfig": "[if(equals(parameters('triggerType'), 'Manual'), createObject('parallelism', parameters('parallelism'), 'replicaCompletionCount', parameters('replicaCompletionCount')), null())]",
                          "scheduleTriggerConfig": "[if(equals(parameters('triggerType'), 'Schedule'), createObject('cronExpression', parameters('cronExpression'), 'parallelism', parameters('parallelism'), 'replicaCompletionCount', parameters('replicaCompletionCount')), null())]"
                        },
                        "template": {
                          "containers": [
                            {
                              "name": "[parameters('containerName')]",
                              "image": "[parameters('containerImage')]",
                              "resources": {
                                "cpu": "[json(parameters('cpu'))]",
                                "memory": "[parameters('memory')]"
                              }
                            }
                          ]
                        }
                      }
                    }
                  ],
                  "outputs": {
                    "containerAppJobName": {
                      "type": "string",
                      "metadata": {
                        "description": "The name of the container app job"
                      },
                      "value": "[parameters('jobName')]"
                    },
                    "containerAppJobId": {
                      "type": "string",
                      "metadata": {
                        "description": "The resource ID of the container app job"
                      },
                      "value": "[resourceId('Microsoft.App/jobs', parameters('jobName'))]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', format('deploy-cae-{0}', parameters('environment')))]",
                "[resourceId('Microsoft.Resources/deployments', format('deploy-mi-{0}', parameters('environment')))]"
              ]
            },
            {
              "condition": "[parameters('envParams').deployContainerAppJobData]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('deploy-caj-data-{0}', parameters('environment'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "jobName": {
                    "value": "[format('{0}-{1}', parameters('namePatterns').containerAppJobData, parameters('environment'))]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "containerAppsEnvironmentId": {
                    "value": "[reference(resourceId('Microsoft.Resources/deployments', format('deploy-cae-{0}', parameters('environment'))), '2025-04-01').outputs.containerAppsEnvironmentId.value]"
                  },
                  "managedIdentityId": {
                    "value": "[reference(resourceId('Microsoft.Resources/deployments', format('deploy-mi-{0}', parameters('environment'))), '2025-04-01').outputs.managedIdentityId.value]"
                  },
                  "containerImage": {
                    "value": "[parameters('envParams').containerImage]"
                  },
                  "containerName": {
                    "value": "data-processor"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.40.2.10011",
                      "templateHash": "11408561663524699226"
                    }
                  },
                  "parameters": {
                    "jobName": {
                      "type": "string",
                      "metadata": {
                        "description": "Job name"
                      }
                    },
                    "location": {
                      "type": "string",
                      "defaultValue": "australiaeast",
                      "metadata": {
                        "description": "Azure region for resources"
                      }
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {},
                      "metadata": {
                        "description": "Tags to apply to the container app job"
                      }
                    },
                    "containerAppsEnvironmentId": {
                      "type": "string",
                      "metadata": {
                        "description": "Container Apps Environment resource ID"
                      }
                    },
                    "managedIdentityId": {
                      "type": "string",
                      "metadata": {
                        "description": "Managed identity resource ID"
                      }
                    },
                    "containerImage": {
                      "type": "string",
                      "defaultValue": "mcr.microsoft.com/azuredocs/containerapps-helloworld:latest",
                      "metadata": {
                        "description": "Container image (e.g., mcr.microsoft.com/azuredocs/containerapps-helloworld:latest)"
                      }
                    },
                    "containerName": {
                      "type": "string",
                      "defaultValue": "main-container",
                      "metadata": {
                        "description": "Container name"
                      }
                    },
                    "cpu": {
                      "type": "string",
                      "defaultValue": "0.25",
                      "metadata": {
                        "description": "CPU cores for the container"
                      }
                    },
                    "memory": {
                      "type": "string",
                      "defaultValue": "0.5Gi",
                      "metadata": {
                        "description": "Memory for the container"
                      }
                    },
                    "triggerType": {
                      "type": "string",
                      "defaultValue": "Manual",
                      "allowedValues": [
                        "Manual",
                        "Schedule",
                        "Event"
                      ],
                      "metadata": {
                        "description": "Trigger type for the job"
                      }
                    },
                    "cronExpression": {
                      "type": "string",
                      "defaultValue": "0 0 * * *",
                      "metadata": {
                        "description": "Cron expression for scheduled jobs (only used when triggerType is Schedule)"
                      }
                    },
                    "replicaTimeout": {
                      "type": "int",
                      "defaultValue": 1800,
                      "metadata": {
                        "description": "Replica timeout in seconds"
                      }
                    },
                    "replicaRetryLimit": {
                      "type": "int",
                      "defaultValue": 0,
                      "metadata": {
                        "description": "Replica retry limit"
                      }
                    },
                    "parallelism": {
                      "type": "int",
                      "defaultValue": 1,
                      "metadata": {
                        "description": "Parallelism (number of replicas to start per job execution)"
                      }
                    },
                    "replicaCompletionCount": {
                      "type": "int",
                      "defaultValue": 1,
                      "metadata": {
                        "description": "Replica completions"
                      }
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.App/jobs",
                      "apiVersion": "2023-05-01",
                      "name": "[parameters('jobName')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "identity": {
                        "type": "UserAssigned",
                        "userAssignedIdentities": {
                          "[format('{0}', parameters('managedIdentityId'))]": {}
                        }
                      },
                      "properties": {
                        "environmentId": "[parameters('containerAppsEnvironmentId')]",
                        "configuration": {
                          "replicaTimeout": "[parameters('replicaTimeout')]",
                          "replicaRetryLimit": "[parameters('replicaRetryLimit')]",
                          "triggerType": "[parameters('triggerType')]",
                          "manualTriggerConfig": "[if(equals(parameters('triggerType'), 'Manual'), createObject('parallelism', parameters('parallelism'), 'replicaCompletionCount', parameters('replicaCompletionCount')), null())]",
                          "scheduleTriggerConfig": "[if(equals(parameters('triggerType'), 'Schedule'), createObject('cronExpression', parameters('cronExpression'), 'parallelism', parameters('parallelism'), 'replicaCompletionCount', parameters('replicaCompletionCount')), null())]"
                        },
                        "template": {
                          "containers": [
                            {
                              "name": "[parameters('containerName')]",
                              "image": "[parameters('containerImage')]",
                              "resources": {
                                "cpu": "[json(parameters('cpu'))]",
                                "memory": "[parameters('memory')]"
                              }
                            }
                          ]
                        }
                      }
                    }
                  ],
                  "outputs": {
                    "containerAppJobName": {
                      "type": "string",
                      "metadata": {
                        "description": "The name of the container app job"
                      },
                      "value": "[parameters('jobName')]"
                    },
                    "containerAppJobId": {
                      "type": "string",
                      "metadata": {
                        "description": "The resource ID of the container app job"
                      },
                      "value": "[resourceId('Microsoft.App/jobs', parameters('jobName'))]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', format('deploy-cae-{0}', parameters('environment')))]",
                "[resourceId('Microsoft.Resources/deployments', format('deploy-mi-{0}', parameters('environment')))]"
              ]
            },
            {
              "condition": "[parameters('envParams').deploySqlServer]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('deploy-sql-{0}', parameters('environment'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "environment": {
                    "value": "[parameters('environment')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "namePattern": {
                    "value": "[parameters('namePatterns').sqlServer]"
                  },
                  "administratorLogin": {
                    "value": "[parameters('envParams').sqlAdministratorLogin]"
                  },
                  "administratorLoginPassword": {
                    "value": "[parameters('envParams').sqlAdministratorLoginPassword]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.40.2.10011",
                      "templateHash": "4978508426328094359"
                    }
                  },
                  "parameters": {
                    "environment": {
                      "type": "string",
                      "metadata": {
                        "description": "Environment name (dev, uat, prod)"
                      }
                    },
                    "location": {
                      "type": "string",
                      "defaultValue": "australiaeast",
                      "metadata": {
                        "description": "Azure region for resources"
                      }
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {},
                      "metadata": {
                        "description": "Tags to apply to the SQL server"
                      }
                    },
                    "namePattern": {
                      "type": "string",
                      "defaultValue": "sql-rebc",
                      "metadata": {
                        "description": "SQL Server name pattern"
                      }
                    },
                    "administratorLogin": {
                      "type": "string",
                      "metadata": {
                        "description": "SQL Server administrator login"
                      }
                    },
                    "administratorLoginPassword": {
                      "type": "securestring",
                      "metadata": {
                        "description": "SQL Server administrator password"
                      }
                    },
                    "minimalTlsVersion": {
                      "type": "string",
                      "defaultValue": "1.2",
                      "allowedValues": [
                        "1.0",
                        "1.1",
                        "1.2"
                      ],
                      "metadata": {
                        "description": "Minimum TLS version"
                      }
                    }
                  },
                  "variables": {
                    "sqlServerName": "[format('{0}-{1}', parameters('namePattern'), parameters('environment'))]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Sql/servers",
                      "apiVersion": "2023-05-01-preview",
                      "name": "[variables('sqlServerName')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "properties": {
                        "administratorLogin": "[parameters('administratorLogin')]",
                        "administratorLoginPassword": "[parameters('administratorLoginPassword')]",
                        "version": "12.0",
                        "minimalTlsVersion": "[parameters('minimalTlsVersion')]",
                        "publicNetworkAccess": "Disabled",
                        "restrictOutboundNetworkAccess": "Disabled"
                      }
                    }
                  ],
                  "outputs": {
                    "sqlServerName": {
                      "type": "string",
                      "metadata": {
                        "description": "The name of the SQL server"
                      },
                      "value": "[variables('sqlServerName')]"
                    },
                    "sqlServerId": {
                      "type": "string",
                      "metadata": {
                        "description": "The resource ID of the SQL server"
                      },
                      "value": "[resourceId('Microsoft.Sql/servers', variables('sqlServerName'))]"
                    },
                    "sqlServerFqdn": {
                      "type": "string",
                      "metadata": {
                        "description": "The fully qualified domain name of the SQL server"
                      },
                      "value": "[reference(resourceId('Microsoft.Sql/servers', variables('sqlServerName')), '2023-05-01-preview').fullyQualifiedDomainName]"
                    }
                  }
                }
              }
            },
            {
              "condition": "[parameters('envParams').deploySqlDatabase]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('deploy-db-{0}', parameters('environment'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "environment": {
                    "value": "[parameters('environment')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "namePattern": {
                    "value": "[parameters('namePatterns').sqlDatabase]"
                  },
                  "sqlServerName": {
                    "value": "[reference(resourceId('Microsoft.Resources/deployments', format('deploy-sql-{0}', parameters('environment'))), '2025-04-01').outputs.sqlServerName.value]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.40.2.10011",
                      "templateHash": "3483007314942101452"
                    }
                  },
                  "parameters": {
                    "environment": {
                      "type": "string",
                      "metadata": {
                        "description": "Environment name (dev, uat, prod)"
                      }
                    },
                    "location": {
                      "type": "string",
                      "defaultValue": "australiaeast",
                      "metadata": {
                        "description": "Azure region for resources"
                      }
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {},
                      "metadata": {
                        "description": "Tags to apply to the SQL database"
                      }
                    },
                    "namePattern": {
                      "type": "string",
                      "defaultValue": "db-rebc",
                      "metadata": {
                        "description": "SQL Database name pattern"
                      }
                    },
                    "sqlServerName": {
                      "type": "string",
                      "metadata": {
                        "description": "SQL Server name"
                      }
                    },
                    "skuName": {
                      "type": "string",
                      "defaultValue": "S0",
                      "allowedValues": [
                        "Basic",
                        "S0",
                        "S1",
                        "S2",
                        "S3",
                        "S4",
                        "S6",
                        "S7",
                        "S9",
                        "S12"
                      ],
                      "metadata": {
                        "description": "Database SKU name"
                      }
                    },
                    "skuTier": {
                      "type": "string",
                      "defaultValue": "Standard",
                      "allowedValues": [
                        "Basic",
                        "Standard",
                        "Premium"
                      ],
                      "metadata": {
                        "description": "Database SKU tier"
                      }
                    },
                    "capacity": {
                      "type": "int",
                      "defaultValue": 10,
                      "metadata": {
                        "description": "Database capacity in DTUs"
                      }
                    },
                    "maxSizeBytes": {
                      "type": "int",
                      "defaultValue": 5368709120,
                      "metadata": {
                        "description": "Maximum size of the database in bytes"
                      }
                    },
                    "collation": {
                      "type": "string",
                      "defaultValue": "SQL_Latin1_General_CP1_CI_AS",
                      "metadata": {
                        "description": "Collation of the database"
                      }
                    }
                  },
                  "variables": {
                    "databaseName": "[format('{0}-{1}', parameters('namePattern'), parameters('environment'))]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Sql/servers/databases",
                      "apiVersion": "2023-05-01-preview",
                      "name": "[format('{0}/{1}', parameters('sqlServerName'), variables('databaseName'))]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "sku": {
                        "name": "[parameters('skuName')]",
                        "tier": "[parameters('skuTier')]",
                        "capacity": "[parameters('capacity')]"
                      },
                      "properties": {
                        "collation": "[parameters('collation')]",
                        "maxSizeBytes": "[parameters('maxSizeBytes')]",
                        "catalogCollation": "[parameters('collation')]",
                        "zoneRedundant": false,
                        "readScale": "Disabled",
                        "requestedBackupStorageRedundancy": "Local"
                      }
                    }
                  ],
                  "outputs": {
                    "sqlDatabaseName": {
                      "type": "string",
                      "metadata": {
                        "description": "The name of the SQL database"
                      },
                      "value": "[variables('databaseName')]"
                    },
                    "sqlDatabaseId": {
                      "type": "string",
                      "metadata": {
                        "description": "The resource ID of the SQL database"
                      },
                      "value": "[resourceId('Microsoft.Sql/servers/databases', split(format('{0}/{1}', parameters('sqlServerName'), variables('databaseName')), '/')[0], split(format('{0}/{1}', parameters('sqlServerName'), variables('databaseName')), '/')[1])]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', format('deploy-sql-{0}', parameters('environment')))]"
              ]
            },
            {
              "condition": "[parameters('envParams').deployPrivateEndpointSqlServer]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('deploy-pe-sql-{0}', parameters('environment'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "privateEndpointName": {
                    "value": "[format('{0}-{1}', parameters('namePatterns').privateEndpointSqlServer, parameters('environment'))]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "subnetId": {
                    "value": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('existingVnetResourceGroup')), 'Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), parameters('subnetName'))]"
                  },
                  "privateLinkServiceId": {
                    "value": "[reference(resourceId('Microsoft.Resources/deployments', format('deploy-sql-{0}', parameters('environment'))), '2025-04-01').outputs.sqlServerId.value]"
                  },
                  "groupIds": {
                    "value": [
                      "sqlServer"
                    ]
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.40.2.10011",
                      "templateHash": "7841778166094210874"
                    }
                  },
                  "parameters": {
                    "privateEndpointName": {
                      "type": "string",
                      "metadata": {
                        "description": "Private endpoint name"
                      }
                    },
                    "location": {
                      "type": "string",
                      "defaultValue": "australiaeast",
                      "metadata": {
                        "description": "Azure region for resources"
                      }
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {},
                      "metadata": {
                        "description": "Tags to apply to the private endpoint"
                      }
                    },
                    "subnetId": {
                      "type": "string",
                      "metadata": {
                        "description": "Subnet resource ID where the private endpoint will be created"
                      }
                    },
                    "privateLinkServiceId": {
                      "type": "string",
                      "metadata": {
                        "description": "Resource ID of the service to create a private endpoint for"
                      }
                    },
                    "groupIds": {
                      "type": "array",
                      "metadata": {
                        "description": "Group IDs for the private endpoint (e.g., registry, sqlServer, managedEnvironments)"
                      }
                    },
                    "enablePrivateDnsIntegration": {
                      "type": "bool",
                      "defaultValue": false,
                      "metadata": {
                        "description": "Enable private DNS integration"
                      }
                    },
                    "privateDnsZoneIds": {
                      "type": "array",
                      "defaultValue": [],
                      "metadata": {
                        "description": "Private DNS Zone IDs for DNS integration"
                      }
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/privateEndpoints",
                      "apiVersion": "2023-05-01",
                      "name": "[parameters('privateEndpointName')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "properties": {
                        "subnet": {
                          "id": "[parameters('subnetId')]"
                        },
                        "privateLinkServiceConnections": [
                          {
                            "name": "[parameters('privateEndpointName')]",
                            "properties": {
                              "privateLinkServiceId": "[parameters('privateLinkServiceId')]",
                              "groupIds": "[parameters('groupIds')]"
                            }
                          }
                        ]
                      }
                    },
                    {
                      "condition": "[and(parameters('enablePrivateDnsIntegration'), greater(length(parameters('privateDnsZoneIds')), 0))]",
                      "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
                      "apiVersion": "2023-05-01",
                      "name": "[format('{0}/{1}', parameters('privateEndpointName'), 'default')]",
                      "properties": {
                        "copy": [
                          {
                            "name": "privateDnsZoneConfigs",
                            "count": "[length(parameters('privateDnsZoneIds'))]",
                            "input": {
                              "name": "[format('config{0}', copyIndex('privateDnsZoneConfigs'))]",
                              "properties": {
                                "privateDnsZoneId": "[parameters('privateDnsZoneIds')[copyIndex('privateDnsZoneConfigs')]]"
                              }
                            }
                          }
                        ]
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/privateEndpoints', parameters('privateEndpointName'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "privateEndpointName": {
                      "type": "string",
                      "metadata": {
                        "description": "The name of the private endpoint"
                      },
                      "value": "[parameters('privateEndpointName')]"
                    },
                    "privateEndpointId": {
                      "type": "string",
                      "metadata": {
                        "description": "The resource ID of the private endpoint"
                      },
                      "value": "[resourceId('Microsoft.Network/privateEndpoints', parameters('privateEndpointName'))]"
                    },
                    "privateEndpointIpAddress": {
                      "type": "string",
                      "metadata": {
                        "description": "The private IP address of the private endpoint"
                      },
                      "value": "[reference(resourceId('Microsoft.Network/privateEndpoints', parameters('privateEndpointName')), '2023-05-01').customDnsConfigs[0].ipAddresses[0]]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', format('deploy-sql-{0}', parameters('environment')))]"
              ]
            }
          ],
          "outputs": {
            "managedIdentityId": {
              "type": "string",
              "value": "[if(parameters('envParams').deployManagedIdentity, reference(resourceId('Microsoft.Resources/deployments', format('deploy-mi-{0}', parameters('environment'))), '2025-04-01').outputs.managedIdentityId.value, '')]"
            },
            "containerRegistryName": {
              "type": "string",
              "value": "[if(parameters('envParams').deployContainerRegistry, reference(resourceId('Microsoft.Resources/deployments', format('deploy-acr-{0}', parameters('environment'))), '2025-04-01').outputs.containerRegistryName.value, '')]"
            },
            "containerRegistryLoginServer": {
              "type": "string",
              "value": "[if(parameters('envParams').deployContainerRegistry, reference(resourceId('Microsoft.Resources/deployments', format('deploy-acr-{0}', parameters('environment'))), '2025-04-01').outputs.containerRegistryLoginServer.value, '')]"
            },
            "containerAppsEnvironmentName": {
              "type": "string",
              "value": "[if(parameters('envParams').deployContainerAppsEnvironment, reference(resourceId('Microsoft.Resources/deployments', format('deploy-cae-{0}', parameters('environment'))), '2025-04-01').outputs.containerAppsEnvironmentName.value, '')]"
            },
            "sqlServerName": {
              "type": "string",
              "value": "[if(parameters('envParams').deploySqlServer, reference(resourceId('Microsoft.Resources/deployments', format('deploy-sql-{0}', parameters('environment'))), '2025-04-01').outputs.sqlServerName.value, '')]"
            },
            "sqlDatabaseName": {
              "type": "string",
              "value": "[if(parameters('envParams').deploySqlDatabase, reference(resourceId('Microsoft.Resources/deployments', format('deploy-db-{0}', parameters('environment'))), '2025-04-01').outputs.sqlDatabaseName.value, '')]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-rg-{0}', parameters('environment')))]"
      ]
    }
  ],
  "outputs": {
    "resourceGroupName": {
      "type": "string",
      "value": "[if(variables('envParams').deployResourceGroup, reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-rg-{0}', parameters('environment'))), '2025-04-01').outputs.resourceGroupName.value, variables('resourceGroupName'))]"
    },
    "managedIdentityId": {
      "type": "string",
      "value": "[if(variables('envParams').deployManagedIdentity, reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-resources-{0}', parameters('environment'))), '2025-04-01').outputs.managedIdentityId.value, '')]"
    },
    "containerRegistryName": {
      "type": "string",
      "value": "[if(variables('envParams').deployContainerRegistry, reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-resources-{0}', parameters('environment'))), '2025-04-01').outputs.containerRegistryName.value, '')]"
    },
    "containerRegistryLoginServer": {
      "type": "string",
      "value": "[if(variables('envParams').deployContainerRegistry, reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-resources-{0}', parameters('environment'))), '2025-04-01').outputs.containerRegistryLoginServer.value, '')]"
    },
    "containerAppsEnvironmentName": {
      "type": "string",
      "value": "[if(variables('envParams').deployContainerAppsEnvironment, reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-resources-{0}', parameters('environment'))), '2025-04-01').outputs.containerAppsEnvironmentName.value, '')]"
    },
    "sqlServerName": {
      "type": "string",
      "value": "[if(variables('envParams').deploySqlServer, reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-resources-{0}', parameters('environment'))), '2025-04-01').outputs.sqlServerName.value, '')]"
    },
    "sqlDatabaseName": {
      "type": "string",
      "value": "[if(variables('envParams').deploySqlDatabase, reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-resources-{0}', parameters('environment'))), '2025-04-01').outputs.sqlDatabaseName.value, '')]"
    }
  }
}