# Azure DevOps Pipeline for REBC Infrastructure

trigger: none
pr: none

parameters:
  - name: environment
    displayName: 'Environment'
    type: string
    default: dev1
    values:
      - dev1
      - sit
      - uat
      - prod

  - name: whatIf
    displayName: 'What-If (preview changes only)'
    type: boolean
    default: false

pool:
  vmImage: 'ubuntu-latest'

variables:
  azureServiceConnection: 'ado-sb'

stages:
  - stage: Validate
    displayName: 'Validate Bicep'
    jobs:
      - job: ValidateBicep
        displayName: 'Validate Bicep Templates'
        steps:
          - script: az bicep build --file main.bicep
            workingDirectory: 'library'
            displayName: 'Validate Bicep'

  - stage: Deploy
    displayName: 'Deploy Infrastructure (${{ parameters.environment }})'
    dependsOn: Validate
    jobs:
      - deployment: DeployInfrastructure
        displayName: 'Deploy to ${{ parameters.environment }}'
        environment: ${{ parameters.environment }}
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self

                - ${{ if eq(parameters.whatIf, true) }}:
                  - task: AzureCLI@2
                    displayName: 'What-If Infrastructure (${{ parameters.environment }})'
                    inputs:
                      azureSubscription: ${{ variables.azureServiceConnection }}
                      scriptType: 'bash'
                      scriptLocation: 'inlineScript'
                      inlineScript: |
                        az deployment sub what-if \
                          --location australiaeast \
                          --template-file library/main.bicep \
                          --parameters environment=${{ parameters.environment }} \
                          --name deploy-bcrev-${{ parameters.environment }}

                - ${{ else }}:
                  - task: AzureCLI@2
                    displayName: 'Deploy Infrastructure (${{ parameters.environment }})'
                    inputs:
                      azureSubscription: ${{ variables.azureServiceConnection }}
                      scriptType: 'bash'
                      scriptLocation: 'inlineScript'
                      inlineScript: |
                        az deployment sub create \
                          --location australiaeast \
                          --template-file library/main.bicep \
                          --parameters environment=${{ parameters.environment }} \
                          --name deploy-bcrev-${{ parameters.environment }}
