# Azure DevOps Pipeline for REBC Infrastructure

trigger: none

parameters:
  - name: environment
    displayName: 'Environment'
    type: string
    default: dev1
    values:
      - dev1
      - sit
      - uat
      - prod

  # DEPLOYMENT IS OFF BY DEFAULT.
  # Set confirmDeploy to true in the pipeline run dialog to actually deploy.
  - name: confirmDeploy
    displayName: 'Confirm deployment (must be true to deploy)'
    type: boolean
    default: false

pool:
  vmImage: 'ubuntu-latest'

variables:
  azureServiceConnection: 'ado-sb'

steps:
  - script: az bicep build --file main.bicep
    workingDirectory: 'library'
    displayName: 'Validate Bicep'

  # Only runs when confirmDeploy is explicitly set to true â€” skipped by default.
  - task: AzureCLI@2
    displayName: 'Deploy Infrastructure (${{ parameters.environment }})'
    condition: and(succeeded(), eq(parameters.confirmDeploy, true))
    inputs:
      azureSubscription: ${{ variables.azureServiceConnection }}
      scriptType: 'bash'
      scriptLocation: 'scriptPath'
      scriptPath: 'library/deploy.sh'
      arguments: '${{ parameters.environment }} --confirm'
